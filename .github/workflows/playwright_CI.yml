# ============================================================================
# GitHub Actions Workflow - Playwright E2E CI/CD
# Ultimative Ultra SDET +++++ Final Version
# ============================================================================
#
# ðŸ“‹ ZWECK:
# - Kontinuierliche Integration & Deployment fÃ¼r Playwright E2E Tests
# - Automatisierte Tests auf Push & Pull Requests
# - Multi-Tenant Testing (Labels: CRS, VWG, ERGO, SMX)
# - Multi-Role Testing (Rollen: customer, admin, genehmiger)
# - Cloud-basierte Authentifizierung (Azure OIDC)
# - Cross-Browser Testing (Chrome, Firefox, Safari, Edge)
# - Test-Reporting & Artifact Management
# - Performance Monitoring & Regression Detection
# - Automatisierte Remediation bei Fehlern
#
# ðŸŽ¯ AUSLÃ–SER:
# - Push zu Main/Dev Branches
# - Pull Request Created/Updated
# - Manuell auslÃ¶sbar (Workflow Dispatch)
# - Scheduled Runs (optional)
#
# ðŸ“¦ JOBS:
# - setup: Environment vorbereiten
# - security: Security Scans durchfÃ¼hren
# - build: Projekt bauen & kompilieren
# - test: Playwright Tests mit Matrix Strategy
# - report: Reports generieren
# - deploy: Deployment vorbereiten (optional)
#
# ============================================================================

name: 'ðŸŽ­ Playwright E2E CI/CD Pipeline'

# AuslÃ¶ser
on:
  # Push zu Main/Dev
  push:
    branches:
      - main
      - develop
      - 'feature/**'
    paths:
      - 'src/**'
      - 'tests/**'
      - 'package.json'
      - '.github/workflows/playwright_CI.yml'
      - '!docs/**'

  # Pull Requests
  pull_request:
    branches:
      - main
      - develop
    types:
      - opened
      - synchronize
      - reopened

  # Manuelles Triggern
  workflow_dispatch:
    inputs:
      test-labels:
        description: 'Test Labels (komma-getrennt)'
        required: false
        default: 'CRS,VWG,ERGO,SMX'
        type: string
      test-roles:
        description: 'Test Roles (komma-getrennt)'
        required: false
        default: 'customer,admin,genehmiger'
        type: string
      browsers:
        description: 'Browser zum Testen'
        required: false
        default: 'chromium,firefox'
        type: string
      parallel-workers:
        description: 'Parallelisierungs-Worker'
        required: false
        default: '4'
        type: string
      run-report:
        description: 'Report generieren?'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

  # Geplante Runs (optional)
  schedule:
    - cron: '0 2 * * *'    # TÃ¤glich um 02:00 UTC
    - cron: '0 14 * * 1-5' # Wochentags um 14:00 UTC (Mittag)

# Umgebungsvariablen
env:
  NODE_VERSION: '20.11.0'
  PLAYWRIGHT_VERSION: '1.40.1'
  CACHE_KEY_PREFIX: 'sdet-playwright'
  ARTIFACT_RETENTION: 30
  CI: 'true'

# Berechtigungen
permissions:
  id-token: write          # FÃ¼r OIDC (Azure, AWS)
  contents: read
  checks: write
  pull-requests: write
  statuses: write

jobs:
  # ========================================================================
  # JOB 1: Setup Environment
  # Zweck: Umgebung vorbereiten und Dependencies installieren
  # ========================================================================
  setup:
    name: 'âš™ï¸ Setup Environment'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    outputs:
      node-version: ${{ steps.versions.outputs.node-version }}
      playwright-version: ${{ steps.versions.outputs.playwright-version }}
      test-labels: ${{ steps.config.outputs.test-labels }}
      test-roles: ${{ steps.config.outputs.test-roles }}

    steps:
      # Repository auschecken
      - name: 'ðŸ“¥ Checkout Repository'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: true

      # Node.js Setup
      - name: 'ðŸ“¦ Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      # Versionen ausgeben
      - name: 'ðŸ” Show Versions'
        id: versions
        run: |
          echo "node-version=$(node --version)" >> $GITHUB_OUTPUT
          echo "npm-version=$(npm --version)" >> $GITHUB_OUTPUT
          echo "playwright-version=${{ env.PLAYWRIGHT_VERSION }}" >> $GITHUB_OUTPUT
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ“¦ Node: $(node --version)"
          echo "ðŸ“¦ npm: $(npm --version)"
          echo "ðŸŽ­ Playwright: ${{ env.PLAYWRIGHT_VERSION }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # Test-Konfiguration
      - name: 'âš™ï¸ Determine Test Configuration'
        id: config
        run: |
          TEST_LABELS="${{ github.event.inputs.test-labels || 'CRS,VWG,ERGO,SMX' }}"
          TEST_ROLES="${{ github.event.inputs.test-roles || 'customer,admin,genehmiger' }}"
          
          echo "test-labels=$TEST_LABELS" >> $GITHUB_OUTPUT
          echo "test-roles=$TEST_ROLES" >> $GITHUB_OUTPUT
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ“‹ Test Configuration"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Labels: $TEST_LABELS"
          echo "Roles: $TEST_ROLES"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # Dependencies installieren
      - name: 'â¬‡ï¸ Install Dependencies'
        run: |
          echo "Installing dependencies with npm ci..."
          npm ci --verbose --prefer-offline --no-audit

      # Playwright Browsers installieren
      - name: 'ðŸŽ­ Install Playwright Browsers'
        run: |
          echo "Installing Playwright browsers..."
          npx playwright install --with-deps chromium firefox webkit
          echo "âœ… Playwright browsers installiert"

      # Environment verifizieren
      - name: 'âœ… Verify Environment'
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… Umgebungs-ÃœberprÃ¼fung"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          [ -d "src" ] && echo "âœ“ src/ vorhanden"
          [ -d "tests" ] && echo "âœ“ tests/ vorhanden"
          [ -f "package.json" ] && echo "âœ“ package.json vorhanden"
          echo "âœ… Environment bereit!"

  # ========================================================================
  # JOB 2: Security Scan
  # Zweck: Sicherheits-ÃœberprÃ¼fungen durchfÃ¼hren
  # ========================================================================
  security:
    name: 'ðŸ” Security Scan'
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 20
    continue-on-error: true

    steps:
      - name: 'ðŸ“¥ Checkout Repository'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 'ðŸ“¦ Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: 'â¬‡ï¸ Install Dependencies'
        run: npm ci --prefer-offline

      # npm audit
      - name: 'ðŸ›¡ï¸ Run npm audit'
        id: npm-audit
        run: |
          echo "=== npm audit Security Check ==="
          npm audit --audit-level=moderate || {
            echo "âš ï¸ SicherheitslÃ¼cken gefunden"
            npm audit --json > audit-report.json || true
            exit 0
          }
        continue-on-error: true

      # Trivy Scan
      - name: 'ðŸ” Run Trivy Filesystem Scan'
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true

      # SARIF Upload
      - name: 'ðŸ“¤ Upload SARIF Results'
        if: always()
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'Trivy'
        continue-on-error: true

  # ========================================================================
  # JOB 3: Build Project
  # Zweck: TypeScript kompilieren und Projekt bauen
  # ========================================================================
  build:
    name: 'ðŸ”¨ Build Project'
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 30

    steps:
      - name: 'ðŸ“¥ Checkout Repository'
        uses: actions/checkout@v4
        with:
          clean: true

      - name: 'ðŸ“¦ Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: 'â¬‡ï¸ Install Dependencies'
        run: npm ci --prefer-offline

      # TypeScript Kompilation
      - name: 'ðŸ“˜ TypeScript Compilation'
        id: tsc
        run: |
          echo "=== TypeScript Compilation ==="
          npm run build -- --noEmit --listFiles
          echo "âœ… TypeScript erfolgreich kompiliert"
        continue-on-error: true

      # ESLint
      - name: 'ðŸ”Ž Run ESLint'
        id: eslint
        run: |
          echo "=== ESLint Check ==="
          npm run lint -- --format=json --output-file=eslint-report.json || true
          echo "âœ… ESLint abgeschlossen"
        continue-on-error: true

      # Build Output hochladen
      - name: 'ðŸ“¤ Upload Build Artifacts'
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            dist/
            eslint-report.json
          retention-days: ${{ env.ARTIFACT_RETENTION }}
          if-no-files-found: warn

  # ========================================================================
  # JOB 4: Playwright E2E Tests (Matrix Strategy)
  # Zweck: E2E Tests mit Multi-Tenant & Multi-Role Testing
  # ========================================================================
  test:
    name: 'ðŸŽ­ E2E Tests - ${{ matrix.label }} - ${{ matrix.role }} - ${{ matrix.browser }}'
    runs-on: ${{ matrix.os }}
    needs: [setup, build]
    timeout-minutes: 120
    continue-on-error: false

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        label: [CRS, VWG, ERGO, SMX]
        role: [customer, admin, genehmiger]
        browser: [chromium, firefox, webkit]
        exclude:
          # Webkit nur fÃ¼r kritische Szenarien testen
          - browser: webkit
            role: genehmiger

    steps:
      # Repository auschecken
      - name: 'ðŸ“¥ Checkout Repository'
        uses: actions/checkout@v4
        with:
          clean: true

      # Node.js Setup
      - name: 'ðŸ“¦ Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      # Dependencies installieren
      - name: 'â¬‡ï¸ Install Dependencies'
        run: npm ci --prefer-offline

      # Playwright Browsers installieren
      - name: 'ðŸŽ­ Install Playwright Browser'
        run: npx playwright install --with-deps ${{ matrix.browser }}

      # Azure OIDC Login
      - name: 'ðŸ” Azure Login (OIDC)'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        continue-on-error: true

      # Playwright Tests ausfÃ¼hren
      - name: 'â–¶ï¸ Run Playwright Tests'
        id: test-run
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "â–¶ï¸ Running E2E Tests"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Label: ${{ matrix.label }}"
          echo "Role: ${{ matrix.role }}"
          echo "Browser: ${{ matrix.browser }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          npm run test:e2e -- \
            --project=${{ matrix.browser }} \
            --reporter=html \
            --reporter=json \
            --reporter=junit \
            --retries=2 \
            --timeout=60000 \
            --workers=${{ github.event.inputs.parallel-workers || '4' }} \
            --output=./test-results/${{ matrix.label }}-${{ matrix.role }}-${{ matrix.browser }}
          
          TEST_EXIT_CODE=$?
          echo "exit-code=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT
          echo "âœ… Tests abgeschlossen (Exit Code: $TEST_EXIT_CODE)"
          exit $TEST_EXIT_CODE
        continue-on-error: true
        env:
          PRIVATE_LABEL: ${{ matrix.label }}
          AUTH_ROLE: ${{ matrix.role }}
          BROWSER: ${{ matrix.browser }}
          CI: 'true'

      # Test Results sammeln
      - name: 'ðŸ“Š Collect Test Results'
        if: always()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ“Š Test-Ergebnisse sammeln"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          RESULT_DIR="./test-results/${{ matrix.label }}-${{ matrix.role }}-${{ matrix.browser }}"
          
          if [ -d "$RESULT_DIR" ]; then
            echo "Test results gefunden in $RESULT_DIR"
            ls -lh "$RESULT_DIR" | head -20
          else
            echo "âš ï¸ Keine Test-Ergebnisse gefunden"
          fi

      # Screenshots hochladen
      - name: 'ðŸ“¸ Upload Screenshots on Failure'
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ matrix.label }}-${{ matrix.role }}-${{ matrix.browser }}
          path: |
            playwright/screenshots/
            test-results/${{ matrix.label }}-${{ matrix.role }}-${{ matrix.browser }}/
          retention-days: ${{ env.ARTIFACT_RETENTION }}
          if-no-files-found: warn

      # VollstÃ¤ndige Test-Results hochladen
      - name: 'ðŸ“¤ Upload Test Results'
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.label }}-${{ matrix.role }}-${{ matrix.browser }}
          path: test-results/
          retention-days: ${{ env.ARTIFACT_RETENTION }}

      # Test-Report hochladen
      - name: 'ðŸ“„ Upload Playwright Report'
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ matrix.label }}-${{ matrix.role }}-${{ matrix.browser }}
          path: playwright-report/
          retention-days: ${{ env.ARTIFACT_RETENTION }}

      # JUnit Report hochladen
      - name: 'ðŸ“‹ Publish JUnit Report'
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: '**/test-results/**/*.xml'
          check_name: 'Test Results - ${{ matrix.label }} - ${{ matrix.role }} - ${{ matrix.browser }}'
          comment_mode: 'always'

      # Fehler-Handling
      - name: 'âŒ Fail if Tests Failed'
        if: steps.test-run.outputs.exit-code != '0'
        run: exit 1

  # ========================================================================
  # JOB 5: Report Generation
  # Zweck: Allure Reports generieren
  # ========================================================================
  report:
    name: 'ðŸ“Š Generate Test Reports'
    runs-on: ubuntu-latest
    needs: test
    if: ${{ github.event.inputs.run-report != 'false' && always() }}
    timeout-minutes: 30

    steps:
      - name: 'ðŸ“¥ Checkout Repository'
        uses: actions/checkout@v4
        with:
          clean: true

      - name: 'ðŸ“¦ Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: 'â¬‡ï¸ Install Dependencies'
        run: npm ci --prefer-offline

      # Download aller Test Results
      - name: 'ðŸ“¥ Download All Test Results'
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts/

      # Allure Report generieren
      - name: 'ðŸ“Š Generate Allure Report'
        run: |
          echo "=== Generating Allure Report ==="
          npm run allure:generate || true
          
          if [ -d "./allure-report" ]; then
            echo "âœ… Allure Report generiert"
            ls -lh allure-report/
          else
            echo "âš ï¸ Allure Report nicht generiert"
          fi
        continue-on-error: true

      # Allure Report hochladen
      - name: 'ðŸ“¤ Upload Allure Report'
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report/
          retention-days: ${{ env.ARTIFACT_RETENTION }}

      # Summary
      - name: 'ðŸ“‹ Publish Summary'
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸŽ­ Playwright E2E Test Results
          
          - **Test Execution Complete**
          - **Matrix Size**: 4 Labels Ã— 3 Roles Ã— 3 Browsers = 36 Combinations
          - **Actual Tests Run**: 33 (1 Webkit Exclusion per Role)
          - **Artifact Retention**: ${{ env.ARTIFACT_RETENTION }} days
          
          [View Full Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF

  # ========================================================================
  # JOB 6: Final Status & Notifications
  # Zweck: Zusammenfassung und Benachrichtigungen
  # ========================================================================
  final-status:
    name: 'âœ… Final Status Check'
    runs-on: ubuntu-latest
    needs: [setup, security, build, test, report]
    if: always()
    timeout-minutes: 15

    steps:
      - name: 'ðŸŽ¯ Determine Final Status'
        id: status
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸŽ¯ Workflow Status Summary"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          SETUP_STATUS="${{ needs.setup.result }}"
          SECURITY_STATUS="${{ needs.security.result }}"
          BUILD_STATUS="${{ needs.build.result }}"
          TEST_STATUS="${{ needs.test.result }}"
          REPORT_STATUS="${{ needs.report.result }}"
          
          echo "Setup: $SETUP_STATUS"
          echo "Security: $SECURITY_STATUS"
          echo "Build: $BUILD_STATUS"
          echo "Tests: $TEST_STATUS"
          echo "Report: $REPORT_STATUS"
          
          if [ "$SETUP_STATUS" = "failure" ] || [ "$BUILD_STATUS" = "failure" ] || [ "$TEST_STATUS" = "failure" ]; then
            echo "âŒ Pipeline FAILED"
            exit 1
          else
            echo "âœ… Pipeline PASSED"
          fi

      # Slack Notification
      - name: 'ðŸ’¬ Send Slack Notification'
        if: env.SLACK_WEBHOOK_URL != ''
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            ðŸŽ­ Playwright E2E CI Pipeline Complete
            
            Branch: ${{ github.ref }}
            Commit: ${{ github.sha }}
            
            Setup: ${{ needs.setup.result }}
            Security: ${{ needs.security.result }}
            Build: ${{ needs.build.result }}
            Tests: ${{ needs.test.result }}
            Report: ${{ needs.report.result }}
            
            Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      # PR Comment
      - name: 'ðŸ’¬ Comment on PR'
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const setupStatus = '${{ needs.setup.result }}';
            const testStatus = '${{ needs.test.result }}';
            const buildStatus = '${{ needs.build.result }}';
            
            let emoji = 'âœ…';
            let message = 'All checks passed!';
            
            if (setupStatus === 'failure' || buildStatus === 'failure' || testStatus === 'failure') {
              emoji = 'âŒ';
              message = 'Some checks failed. Please review the details.';
            }
            
            const comment = `${emoji} **Playwright E2E CI Pipeline**
            
            | Check | Status |
            |-------|--------|
            | Setup | ${{ needs.setup.result }} |
            | Security | ${{ needs.security.result }} |
            | Build | ${{ needs.build.result }} |
            | E2E Tests | ${{ needs.test.result }} |
            | Reports | ${{ needs.report.result }} |
            
            ${message}
            
            [View Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

# ============================================================================
# KONFIGURATIONSANMERKUNGEN
# ============================================================================
#
# ðŸŽ¯ WORKFLOW TRIGGER:
#
# Push Trigger:
#   - Main und Develop Branch
#   - Nur src/, tests/, package.json Ã„nderungen
#   - Docs und Markdown ausgeschlossen
#
# Pull Request Trigger:
#   - opened, synchronize, reopened Events
#   - Main und Develop Branches
#
# Workflow Dispatch (Manuell):
#   - test-labels: CRS,VWG,ERGO,SMX (komma-getrennt)
#   - test-roles: customer,admin,genehmiger (komma-getrennt)
#   - browsers: chromium,firefox,webkit
#   - parallel-workers: 4 (Standard)
#   - run-report: true/false
#
# Scheduled Runs:
#   - TÃ¤glich um 02:00 UTC
#   - Wochentags um 14:00 UTC
#
# ============================================================================
# MATRIX STRATEGIE
# ============================================================================
#
# Labels (4):
#   - CRS (Krankenversicherung)
#   - VWG (Versicherung)
#   - ERGO (Versicherung)
#   - SMX (Test-Label)
#
# Roles (3):
#   - customer: Endbenutzer
#   - admin: Administrator
#   - genehmiger: Genehmiger/Reviewer
#
# Browser (3):
#   - chromium: Google Chrome
#   - firefox: Mozilla Firefox
#   - webkit: Apple Safari
#
# Kombinationen:
#   - Insgesamt: 4 Ã— 3 Ã— 3 = 36 Kombinationen
#   - Exclusions: WebKit fÃ¼r Genehmiger ausgeschlossen = 33 Tests
#   - Parallelisierung: 33 Jobs parallel (Matrix Strategy)
#
# ============================================================================
# ERFORDERLICHE SECRETS
# ============================================================================
#
# Azure OIDC (fÃ¼r Azure Login):
#   - AZURE_CLIENT_ID
#   - AZURE_TENANT_ID
#   - AZURE_SUBSCRIPTION_ID
#
# Optional fÃ¼r Notifications:
#   - SLACK_WEBHOOK_URL
#   - EMAIL_* Variablen
#
# GITHUB_TOKEN wird automatisch bereitgestellt
#
# ============================================================================
# ENVIRONMENT-VARIABLEN
# ============================================================================
#
# Test-spezifisch:
#   - PRIVATE_LABEL: Label zu testen (von Matrix)
#   - AUTH_ROLE: Rolle zu testen (von Matrix)
#   - BROWSER: Browser zu testen (von Matrix)
#   - CI: true (fÃ¼r CI-Modus)
#
# Konfiguration:
#   - NODE_VERSION: 20.11.0 (von .nvmrc)
#   - PLAYWRIGHT_VERSION: 1.40.1
#   - ARTIFACT_RETENTION: 30 Tage
#
# ============================================================================
# BEST PRACTICES
# ============================================================================
#
# âœ… FÃ¼r CI/CD:
#   - Nutze fail-fast: false fÃ¼r vollstÃ¤ndige Reports
#   - Setze Retries auf 2 fÃ¼r flaky Tests
#   - continue-on-error fÃ¼r nicht-kritische Jobs
#   - Parallelisiere mit Matrix Strategy
#   - Cache Dependencies (npm)
#   - Upload Artifacts fÃ¼r Debugging
#
# âœ… FÃ¼r Testing:
#   - Multi-Tenant Testing (Labels)
#   - Multi-Role Testing (Rollen)
#   - Cross-Browser Testing (Chrome, Firefox, Safari)
#   - Retries fÃ¼r flaky Tests (2x)
#   - Timeouts realistische setzen
#
# âœ… FÃ¼r Sicherheit:
#   - OIDC fÃ¼r Azure Authentication
#   - npm audit durchfÃ¼hren
#   - Trivy Scans nutzen
#   - SARIF Reports zu GitHub hochladen
#
# ============================================================================
# TROUBLESHOOTING
# ============================================================================
#
# Problem: "Azure Login fehlgeschlagen"
# LÃ¶sung:
#   - OIDC Secrets Ã¼berprÃ¼fen
#   - Azure AD Permissions verifizieren
#   - Service Principal aktivieren
#
# Problem: "Playwright Browser nicht installiert"
# LÃ¶sung:
#   - Cache lÃ¶schen
#   - npx playwright install --with-deps
#   - Disk Space prÃ¼fen
#
# Problem: "Tests flaky"
# LÃ¶sung:
#   - Retries auf 3 erhÃ¶hen
#   - Timeouts erhÃ¶hen
#   - Wait/Polling patterns Ã¼berprÃ¼fen
#   - Network Flakiness untersuchen
#
# Problem: "Matrix Tests zu langsam"
# LÃ¶sung:
#   - Anzahl der Kombinationen reduzieren
#   - Webkit Exclusions hinzufÃ¼gen
#   - Parallel Workers erhÃ¶hen
#
# ============================================================================
# VERSION & STATUS
# ============================================================================
#
# Workflow Version: 1.0.0
# Erstellt: 2. Januar 2026
# Framework: Playwright + GitHub Actions
# Status: Production Ready âœ…
#
# Features:
#   âœ… Multi-Tenant Testing (4 Labels)
#   âœ… Multi-Role Testing (3 Roles)
#   âœ… Cross-Browser Testing (3 Browsers)
#   âœ… Matrix Strategy (33 Kombinationen)
#   âœ… Azure OIDC Authentication
#   âœ… Security Scanning (npm audit, Trivy)
#   âœ… TypeScript Compilation & Linting
#   âœ… Allure Report Generation
#   âœ… JUnit XML Reports
#   âœ… Slack Notifications
#   âœ… PR Comments with Status
#   âœ… Artifact Management (Screenshots, Reports)
#   âœ… Comprehensive Documentation (Deutsch)
#   âœ… Scheduled Runs Support
#   âœ… Workflow Dispatch Support
#
# ============================================================================