// استخدم هذا الملف لإدارة الأسرار (Secrets) بشكل مُحسَّن في بيئات Docker
// تمت ترجمة أسماء المتغيرات، الكلاسات، والدوال إلى العربية، مع الإبقاء على عناصر لغة البرمجة كما هي

import 'dotenv/config';
import * as fs from 'fs';
import * as path from 'path';

/**
 * ==============================
 * الأنواع (Types)
 * ==============================
 */
export interface تهيئة_العلامة_الخاصة {
  رابط: string;                     // URL
  بريد_المستخدم: string;            // USER_EMAIL
  كلمة_مرور_المستخدم: string;       // USER_PASSWORD
  بريد_الموافق?: string;            // APPROVER_EMAIL (اختياري)
  كلمة_مرور_الموافق?: string;       // APPROVER_PASSWORD (اختياري)
  بريد_الدعم?: string;              // SUPPORT_EMAIL
  كلمة_مرور_الدعم?: string;         // SUPPORT_PASSWORD
  البيئة: string;                   // ENVIRONMENT
  رسائل_النظام?: string;            // SYSTEM_EMAILS
  مصادقة_أساسية?: string;           // BASIC_AUTH
  [مفتاح: string]: string | undefined; // مفاتيح إضافية
}

export interface ملف_تهيئة_العلامات {
  [اسم_العلامة: string]: تهيئة_العلامة_الخاصة;
}

/**
 * ==============================
 * الثوابت / الإعدادات
 * ==============================
 */
const الحقول_الإلزامية: ReadonlyArray<keyof تهيئة_العلامة_الخاصة> = [
  'رابط',
  'بريد_المستخدم',
  'كلمة_مرور_المستخدم',
  'البيئة',
];

// الربط: متغير البيئة -> مفتاح التهيئة
const ربط_المتغيرات_البيئية: Readonly<Record<string, keyof تهيئة_العلامة_الخاصة>> = Object.freeze({
  PL_URL: 'رابط',
  PL_USER_EMAIL: 'بريد_المستخدم',
  PL_USER_PASSWORD: 'كلمة_مرور_المستخدم',
  PL_APPROVER_EMAIL: 'بريد_الموافق',
  PL_APPROVER_PASSWORD: 'كلمة_مرور_الموافق',
  PL_SUPPORT_EMAIL: 'بريد_الدعم',
  PL_SUPPORT_PASSWORD: 'كلمة_مرور_الدعم',
  PL_ENVIRONMENT: 'البيئة',
  PL_SYSTEM_EMAILS: 'رسائل_النظام',
  PL_BASIC_AUTH: 'مصادقة_أساسية',
});

/**
 * ==============================
 * مدير_الأسرار (Secrets Manager)
 * ==============================
 */
export class مدير_الأسرار {
  private readonly مسار_ملف_json: string;
  private بيانات_json: ملف_تهيئة_العلامات | null = null;
  private readonly ذاكرة_مؤقتة = new Map<string, Readonly<تهيئة_العلامة_الخاصة>>();

  constructor(اسم_الملف_json?: string) {
    // الأولوية: المعامل -> متغير البيئة -> القيمة الافتراضية
    const ملف = اسم_الملف_json || process.env.PL_CONFIG_PATH || 'PL_config.json';
    this.مسار_ملف_json = path.resolve(ملف);
  }

  /**
   * ------------------------------
   * دوال مساعدة داخلية
   * ------------------------------
   */

  private تأكد_من_تحميل_البيانات(): void {
    if (this.بيانات_json) return; // البيانات محمّلة مسبقًا

    if (!fs.existsSync(this.مسار_ملف_json)) {
      throw new Error(`مدير_الأسرار: ملف التهيئة غير موجود (${this.مسار_ملف_json})`);
    }

    try {
      const محتوى = fs.readFileSync(this.مسار_ملف_json, 'utf-8');
      this.بيانات_json = JSON.parse(محتوى) as ملف_تهيئة_العلامات;
    } catch (خطأ) {
      throw new Error(`مدير_الأسرار: خطأ أثناء تحميل التهيئة: ${خطأ instanceof Error ? خطأ.message : String(خطأ)}`);
    }
  }

  private استبدل_المتغيرات(label: تهيئة_العلامة_الخاصة): تهيئة_العلامة_الخاصة {
    const محلول: تهيئة_العلامة_الخاصة = { ...label };

    for (const مفتاح of Object.keys(محلول)) {
      const قيمة = محلول[مفتاح];
      if (typeof قيمة === 'string' && قيمة.startsWith('${') && قيمة.endsWith('}')) {
        const اسم_المتغير = قيمة.slice(2, -1);
        محلول[مفتاح] = process.env[اسم_المتغير] ?? '';
      }
    }

    return محلول;
  }

  private تحقق_من_الحقول_الإلزامية(label: تهيئة_العلامة_الخاصة, اسم_العلامة: string): void {
    for (const حقل of الحقول_الإلزامية) {
      const قيمة = label[حقل];
      if (!قيمة || !قيمة.trim()) {
        throw new Error(`مدير_الأسرار: العلامة '${اسم_العلامة}' تفتقد الحقل الإلزامي '${حقل}'`);
      }
    }
  }

  private احصل_على_العلامة_داخليًا(اسم_العلامة: string): Readonly<تهيئة_العلامة_الخاصة> {
    if (this.ذاكرة_مؤقتة.has(اسم_العلامة)) {
      return this.ذاكرة_مؤقتة.get(اسم_العلامة)!;
    }

    this.تأكد_من_تحميل_البيانات();

    const تهيئة_خام = this.بيانات_json![اسم_العلامة];
    if (!تهيئة_خام) {
      throw new Error(`مدير_الأسرار: العلامة '${اسم_العلامة}' غير موجودة`);
    }

    const تهيئة_محلولة = this.استبدل_المتغيرات(تهيئة_خام);
    this.تحقق_من_الحقول_الإلزامية(تهيئة_محلولة, اسم_العلامة);

    const مجمّد = Object.freeze(تهيئة_محلولة);
    this.ذاكرة_مؤقتة.set(اسم_العلامة, مجمّد);
    return مجمّد;
  }

  /**
   * ------------------------------
   * الواجهة العامة
   * ------------------------------
   */

  public احصل_على_العلامة_بشكل_متزامن(اسم_العلامة: string): Readonly<تهيئة_العلامة_الخاصة> {
    return this.احصل_على_العلامة_داخليًا(اسم_العلامة);
  }

  public async احصل_على_العلامة(اسم_العلامة: string): Promise<Readonly<تهيئة_العلامة_الخاصة>> {
    return this.احصل_على_العلامة_داخليًا(اسم_العلامة);
  }

  public async حمّل_إلى_متغيرات_البيئة(اسم_العلامة: string): Promise<void> {
    const تهيئة = await this.احصل_على_العلامة(اسم_العلامة);

    for (const [متغير_بيئة, مفتاح_تهيئة] of Object.entries(ربط_المتغيرات_البيئية)) {
      process.env[متغير_بيئة] = تهيئة[مفتاح_تهيئة] ?? '';
    }
  }

  public احصل_على_سر<K extends keyof تهيئة_العلامة_الخاصة>(
    اسم_العلامة: string,
    مفتاح: K,
  ): تهيئة_العلامة_الخاصة[K] {
    return this.احصل_على_العلامة_داخليًا(اسم_العلامة)[مفتاح];
  }

  /**
   * لمسح الذاكرة المؤقتة (للاختبارات أو إعادة التحميل)
   */
  public امسح_الذاكرة_المؤقتة(اسم_العلامة?: string): void {
    if (اسم_العلامة) this.ذاكرة_مؤقتة.delete(اسم_العلامة);
    else this.ذاكرة_مؤقتة.clear();
  }
}

/**
 * ==============================
 * نسخة واحدة + بدء التشغيل
 * ==============================
 */
export const مدير_الأسرار_العام = new مدير_الأسرار();

export async function حمّل_العلامة_من_متغيرات_البيئة(): Promise<void> {
  const اسم_العلامة = process.env.private_label;
  if (!اسم_العلامة) {
    throw new Error('مدير_الأسرار: متغير البيئة "private_label" غير مضبوط');
  }

  await مدير_الأسرار_العام.حمّل_إلى_متغيرات_البيئة(اسم_العلامة);
}

/* ==============================
 * ملاحظات تحسين Docker
 * ==============================
 * - قراءة فقط وآمنة للحاويات
 * - لا يوجد تعديل على الملفات
 * - أسرار عبر متغيرات البيئة فقط
 * - إعدادات غير قابلة للتغيير (Immutable)
 */
